<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Hill Gates Map (MapLibre + Thunderforest + OSM + PMTiles)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@3.0.2/dist/pmtiles.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #map { width:100%; height:100vh; }
    .maplibregl-ctrl-attrib { font-size: 11px; }

    .panel {
      position: absolute; top: 50px; left: 10px; z-index: 1;
      background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 8px;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-width: 260px;
      display: none; /* hidden by default; toggled by button */
    }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 700; }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); display: inline-block; flex: 0 0 14px; }
    .sw-red    { background: #e53935; }
    .sw-blue   { background: #1e88e5; }
    .sw-green  { background: #43a047; }
    .sw-black  { background: #000000; border-radius: 2px; height: 10px; }
    .legend-note { font-size: 12px; color: #555; margin-top: 6px; }

    .legend-toggle {
      position: absolute; top: 10px; left: 10px; z-index: 2;
      background: #fff; border: 1px solid #ccc; border-radius: 4px;
      padding: 6px 10px; font-size: 13px; cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .legend-toggle:hover { background: #f0f0f0; }
  </style>
</head>
<body>
<div id="map"></div>

<button class="legend-toggle">Legend</button>

<div class="panel" id="legend-panel">
  <h3>Basemap</h3>
  <label class="row"><input type="radio" name="basemap" value="outdoors" checked> Outdoors</label>
  <label class="row"><input type="radio" name="basemap" value="landscape"> Landscape</label>
  <label class="row"><input type="radio" name="basemap" value="osm"> OSM Standard</label>

  <h3>Layers</h3>
  <label class="row"><input type="checkbox" id="chk-gates" checked><span class="swatch sw-red"></span> Gates</label>
  <label class="row"><input type="checkbox" id="chk-stiles" checked><span class="swatch sw-blue"></span> Stiles</label>
  <label class="row"><input type="checkbox" id="chk-kissing" checked><span class="swatch sw-green"></span> Kissing Gates</label>
  <label class="row"><input type="checkbox" id="chk-walls" checked><span class="swatch sw-black"></span> Walls (dashed)</label>
  <div class="legend-note">Tip: toggle layers for clarity when zoomed out.</div>
</div>

<script>
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const BASE = "https://s3.eu-west-2.amazonaws.com/www.libre-maps.com/cumbria/";
  const GATES_URL   = BASE + "gates.pmtiles";
  const STILES_URL  = BASE + "stiles.pmtiles";
  const KISSING_URL = BASE + "kissing_gates.pmtiles";
  const WALLS_URL   = BASE + "walls.pmtiles";

  [GATES_URL, STILES_URL, KISSING_URL, WALLS_URL].forEach(u => protocol.add(new pmtiles.PMTiles(u)));

  const style = {
    "version": 8,
    "sources": {
      "tf-outdoors": { "type": "raster",
        "tiles": ["https://tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=d84b6d1e1a4e4762a54350b8fe7dc9ae"],
        "tileSize": 256, "maxzoom": 20
      },
      "tf-landscape": { "type": "raster",
        "tiles": ["https://tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=d84b6d1e1a4e4762a54350b8fe7dc9ae"],
        "tileSize": 256, "maxzoom": 20
      },
      "osm-standard": { "type": "raster",
        "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        "tileSize": 256, "maxzoom": 19,
        "attribution": "Â© OpenStreetMap contributors"
      },
      "gates":         { "type": "vector", "url": "pmtiles://" + GATES_URL },
      "stiles":        { "type": "vector", "url": "pmtiles://" + STILES_URL },
      "kissing_gates": { "type": "vector", "url": "pmtiles://" + KISSING_URL },
      "walls":         { "type": "vector", "url": "pmtiles://" + WALLS_URL }
    },
    "layers": [
      { "id": "tf-outdoors-layer", "type": "raster", "source": "tf-outdoors", "layout": { "visibility": "visible" } },
      { "id": "tf-landscape-layer", "type": "raster", "source": "tf-landscape", "layout": { "visibility": "none" } },
      { "id": "osm-layer", "type": "raster", "source": "osm-standard", "layout": { "visibility": "none" } },

      { "id": "gates-circles", "type": "circle", "source": "gates", "source-layer": "gates",
        "paint": {
          "circle-radius": ["interpolate", ["linear"], ["zoom"], 8, 2, 14, 3, 18, 5],
          "circle-color": "#e53935",
          "circle-stroke-color": "#fff",
          "circle-stroke-width": 1
        }
      },
      { "id": "stiles-circles", "type": "circle", "source": "stiles", "source-layer": "stiles",
        "paint": {
          "circle-radius": ["interpolate", ["linear"], ["zoom"], 8, 2, 14, 3, 18, 5],
          "circle-color": "#1e88e5",
          "circle-stroke-color": "#fff",
          "circle-stroke-width": 1
        }
      },
      { "id": "kissing-circles", "type": "circle", "source": "kissing_gates", "source-layer": "kissing_gates",
        "paint": {
          "circle-radius": ["interpolate", ["linear"], ["zoom"], 8, 2, 14, 3, 18, 5],
          "circle-color": "#43a047",
          "circle-stroke-color": "#fff",
          "circle-stroke-width": 1
        }
      },
      { "id": "walls-line", "type": "line", "source": "walls", "source-layer": "walls",
        "layout": { "line-cap": "round", "line-join": "round" },
        "paint": {
          "line-color": "#000000",
          "line-width": ["interpolate", ["linear"], ["zoom"], 8, 0.5, 16, 3],
          "line-opacity": 0.9,
          "line-dasharray": [4, 2]
        }
      }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [-3.08, 54.46],
    zoom: 12,
    hash: true
  });

  function setVisibility(layerId, visible) {
    if (map.getLayer(layerId)) {
      map.setLayoutProperty(layerId, "visibility", visible ? "visible" : "none");
    }
  }

  map.on("load", () => {
    // Layer toggles
    document.getElementById("chk-gates").onchange   = e => setVisibility("gates-circles", e.target.checked);
    document.getElementById("chk-stiles").onchange  = e => setVisibility("stiles-circles", e.target.checked);
    document.getElementById("chk-kissing").onchange = e => setVisibility("kissing-circles", e.target.checked);
    document.getElementById("chk-walls").onchange   = e => setVisibility("walls-line", e.target.checked);

    // Basemap toggles
    document.querySelectorAll("input[name='basemap']").forEach(radio => {
      radio.addEventListener("change", e => {
        const choice = e.target.value;
        map.setLayoutProperty("tf-outdoors-layer", "visibility", choice === "outdoors" ? "visible" : "none");
        map.setLayoutProperty("tf-landscape-layer", "visibility", choice === "landscape" ? "visible" : "none");
        map.setLayoutProperty("osm-layer", "visibility", choice === "osm" ? "visible" : "none");
      });
    });

    // Legend toggle
    const legendBtn = document.querySelector(".legend-toggle");
    const legendPanel = document.getElementById("legend-panel");
    legendBtn.addEventListener("click", () => {
      legendPanel.style.display = (legendPanel.style.display === "none" || !legendPanel.style.display) ? "block" : "none";
    });

    // Scale bar (imperial: miles/feet)
    const scale = new maplibregl.ScaleControl({ maxWidth: 120, unit: "imperial" });
    map.addControl(scale, "bottom-left");

    // Geolocate control (top-right)
    const geolocate = new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true,
      fitBoundsOptions: { maxZoom: 15 }
    });
    map.addControl(geolocate, "top-right");

    // Navigation control (zoom + compass, top-right)
    const nav = new maplibregl.NavigationControl({ visualizePitch: true });
    map.addControl(nav, "top-right");
  });
</script>
</body>
</html>